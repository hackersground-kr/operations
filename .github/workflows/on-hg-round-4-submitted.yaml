name: On Team Pitch Submitted

on:
  issues:
    types:
    - opened
  workflow_dispatch:
    inputs:
      issue-number:
        description: 'Issue number'
        required: true

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write

jobs:
  verification-start:
    name: 'Starting verification'

    runs-on: ubuntu-latest

    steps:
    # - name: Check event payload
    #   shell: pwsh
    #   run: |
    #     $eventPayload = ${{ toJson(github) }}

    - name: Check issue details
      id: issue
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
      run: |
        if ("${{ github.event_name}}" -eq "workflow_dispatch") {
          echo "number=${{ github.event.inputs.issue-number }}" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8

          $issue = $(gh api /repos/${{ github.repository }}/issues/${{ github.event.inputs.issue-number }} | ConvertFrom-Json)
          echo "title=$($issue.title)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

          $body = $($issue.body) | ConvertTo-Json -Compress
          echo "body=$body" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

          $created_at=$($issue.created_at.ToString("yyyy-MM-ddTHH:mm:ss.fffzzz"))
          echo "created_at=$created_at" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

          echo "githubId=$($issue.user.login)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "assignee=$($issue.assignee)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        } else {
          echo "number=${{ github.event.issue.number }}" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8

          echo "title=$('${{ github.event.issue.title }}')" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

          $body = $("${{ github.event.issue.body }}") | ConvertTo-Json -Compress
          echo "body=$body" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

          echo "created_at=$('${{ github.event.issue.created_at }}')" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "githubId=$('${{ github.event.issue.user.login }}')" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "assignee=$('${{ github.event.issue.assignee }}')" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        }

    - name: Check issue date/time
      id: checkpoint
      shell: pwsh
      run: |
        $tz = [TimeZoneInfo]::FindSystemTimeZoneById("Asia/Seoul")
        $dateSubmitted = [DateTimeOffset]::Parse("${{ steps.issue.outputs.created_at }}")
        $offset = $tz.GetUtcOffset($dateSubmitted)

        $dateSubmitted = $dateSubmitted.ToOffset($offset)
        $dateDue = $([DateTimeOffset]::Parse("${{ vars.HG_DUE_ROUND_4 }}"))
        $isOverdue = "$($dateSubmitted -gt $dateDue)".ToLowerInvariant()

        $dateSubmittedValue = $dateSubmitted.ToString("yyyy-MM-ddTHH:mm:ss.fffzzz")
        $dateDueValue = $dateDue.ToString("yyyy-MM-ddTHH:mm:ss.fffzzz")

        echo "dateSubmitted=$dateSubmittedValue" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "dateDue=$dateDueValue" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "isOverdue=$isOverdue" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

    - name: Check issue type
      id: issue-type
      shell: pwsh
      run: |
        $title = "${{ steps.issue.outputs.title }}"

        $isCsc = $title.Contains("ì±Œë¦°ì§€ ì™„ë£Œ ì¸ì¦")
        $isTeamTopic = $title.Contains("í•´ì»¤í†¤ ì£¼ì œ ì œì¶œ")
        $isTeamApp = $title.Contains("í•´ì»¤í†¤ ì•± ì œì¶œ")
        $isTeamPitch = $title.Contains("í•´ì»¤í†¤ ë°œí‘œìë£Œ ì œì¶œ")

        echo "isCsc=$isCsc" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "isTeamTopic=$isTeamTopic" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "isTeamApp=$isTeamApp" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "isTeamPitch=$isTeamPitch" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

    - name: Check team name
      if: steps.issue-type.outputs.isTeamPitch == 'true'
      id: team
      shell: pwsh
      run: |
        $title = "${{ steps.issue.outputs.title }}"
        $teamName = $title.Contains("]") ? $title.Substring(0, $title.IndexOf(']')).Replace("[", "").Replace("]", "").Trim().ToLowerInvariant() : ""

        echo "name=$teamName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

    - name: Extract team repository link
      if: steps.issue-type.outputs.isTeamPitch == 'true'
      id: repository
      shell: pwsh
      run: |
        $scriptUrl = "https://raw.githubusercontent.com/hackersground-kr/operations/main/get-teamrepository/Get-TeamRepository.ps1"
        Invoke-RestMethod $scriptUrl | Out-File ~/Get-TeamRepository.ps1

        $repositoryName = $(~/Get-TeamRepository.ps1 -Text ${{ steps.issue.outputs.body }})

        echo "name=$repositoryName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

    - name: Add a label - Overdue
      if: steps.issue-type.outputs.isTeamPitch == 'true' && steps.checkpoint.outputs.isOverdue == 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue edit ${{ steps.issue.outputs.number }} \
          --add-label "hackathon,team-topic,overdue" \
          -R ${{ github.event.repository.full_name }}

    - name: Comment to issue - Overdue
      if: steps.issue-type.outputs.isTeamPitch == 'true' && steps.checkpoint.outputs.isOverdue == 'true'
      uses: actions-cool/issues-helper@v3
      with:
        actions: 'create-comment'
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ steps.issue.outputs.number }}
        body: |
          ğŸ‘‹ğŸ¼ @${{ steps.issue.outputs.githubId }} ë‹˜!

          * ì´ìŠˆ ì œì¶œ ì‹œê°: ${{ steps.checkpoint.outputs.dateSubmitted }}
          * ì´ìŠˆ ë§ˆê° ì‹œê°: ${{ steps.checkpoint.outputs.dateDue }}

          ì•ˆíƒ€ê¹ê²Œë„ ì œì¶œí•˜ì‹  ì´ìŠˆëŠ” ë§ˆê° ê¸°í•œì¸ ${{ steps.checkpoint.outputs.dateDue }}ì„ ë„˜ê¸°ì…¨ìŠµë‹ˆë‹¤. ğŸ˜­ ë”°ë¼ì„œ, í–¥í›„ ì‹¬ì‚¬ì‹œ ê°ì  ìš”ì†Œë¡œ ì‘ìš©í•˜ê²Œ ë©ë‹ˆë‹¤.

          í•˜ì§€ë§Œ ì•„ì§ ìµœì¢… ì‹¬ì‚¬ê°€ ë‚¨ì•˜ìŠµë‹ˆë‹¤! ğŸ’ª ì–¼ë§ˆ ë‚¨ì§€ ì•Šì•˜ìœ¼ë‹ˆ ëê¹Œì§€ ë¶„ë°œí•´ ì£¼ì„¸ìš”!

    - name: Add a label - Acknowledge
      if: steps.issue-type.outputs.isTeamPitch == 'true' && steps.checkpoint.outputs.isOverdue == 'false'
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue edit ${{ steps.issue.outputs.number }} \
          --add-label "hackathon,team-topic,submitted,verifying" \
          -R ${{ github.event.repository.full_name }}

    - name: Get random assignee
      if: steps.issue-type.outputs.isTeamPitch == 'true' && steps.checkpoint.outputs.isOverdue == 'false' && steps.issue.outputs.assignee == ''
      id: assignee
      shell: pwsh
      run: |
        $scriptUrl = "https://raw.githubusercontent.com/hackersground-kr/operations/main/get-randomassignee/Get-RandomAssignee.ps1"
        Invoke-RestMethod $scriptUrl | Out-File ~/Get-RandomAssignee.ps1
        $assignee = $(~/Get-RandomAssignee.ps1 -Assignees "${{ vars.INSPECTORS }}")

        echo "githubId=$assignee" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

    - name: Assign an inspector
      if: steps.issue-type.outputs.isTeamPitch == 'true' && steps.checkpoint.outputs.isOverdue == 'false' && steps.issue.outputs.assignee == ''
      uses: actions-cool/issues-helper@v3
      with:
        actions: 'add-assignees'
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ steps.issue.outputs.number }}
        assignees: ${{ steps.assignee.outputs.githubId }}

    - name: Comment to issue - Acknowledge
      if: steps.issue-type.outputs.isTeamPitch == 'true' && steps.checkpoint.outputs.isOverdue == 'false'
      uses: actions-cool/issues-helper@v3
      with:
        actions: 'create-comment'
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ steps.issue.outputs.number }}
        emoji: '+1,rocket'
        body: |
          ğŸ‘‹ğŸ¼ @${{ steps.issue.outputs.githubId }} ë‹˜!

          í•´ì»¤í†¤ ë°œí‘œìë£Œë¥¼ ì œì¶œí•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.

          @${{ steps.assignee.outputs.githubId }} ë‹˜ê»˜ì„œ ìµœëŒ€í•œ ë¹ ë¥´ê²Œ í™•ì¸í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤! ğŸ˜Š

          ê±°ì˜ ë‹¤ ì™”ìŠµë‹ˆë‹¤! ğŸ’ª ì €í¬ê°€ ë°œí‘œìë£Œ ì œì¶œì„ í™•ì¸í•œ í›„ ê²°ê³¼ë¥¼ ì•Œë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.
          
          ì´ì œ ìµœì¢… ì‹¬ì‚¬ê¹Œì§€ ì–¼ë§ˆ ë‚¨ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤! ğŸš€

    - name: Call Power Automate workflow
      if: steps.issue-type.outputs.isTeamPitch == 'true' && steps.checkpoint.outputs.isOverdue == 'false'
      id: request
      uses: fjogeleit/http-request-action@v1
      with:
        url: ${{ secrets.PAU_ON_ROUND_4_SUBMITTED_URL }}
        method: 'POST'
        data: '{ "issueNumber": ${{ steps.issue.outputs.number }}, "githubId": "${{ steps.issue.outputs.githubId }}", "teamName": "${{ steps.team.outputs.name }}", "repositoryName": "${{ steps.repository.outputs.name }}", "dateSubmitted": "${{ steps.checkpoint.outputs.dateSubmitted }}" }'
