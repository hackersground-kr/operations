name: On Challenge Submitted

on:
  issues:
    types:
      - opened
  workflow_dispatch:
    inputs:
      issue-number:
        description: "Issue number"
        required: true

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write

jobs:
  verification-start:
    name: "Starting verification"

    runs-on: ubuntu-latest

    steps:
      - name: Check event payload
        shell: pwsh
        run: |
          $eventPayload = '${{ toJson(github) }}'

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get GitHub access token
        id: github-connect
        shell: pwsh
        run: |
          $token = ./gha-scripts/Get-GitHubAccessToken.ps1 `
            -AccessTokenIDs "${{ vars.ACCESS_TOKEN_IDS }}" `
            -ApimBaseUrl "${{ vars.APIM_BASE_URL }}" `
            -ApimApiKey "${{ secrets.APIM_SUBSCRIPTION_KEY }}"

          echo "::add-mask::$token"
          echo "token=$token" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8

      - name: Check issue details
        id: issue
        shell: pwsh
        env:
          GH_TOKEN: ${{ steps.github-connect.outputs.token }}
        run: |
          $payload = '${{ toJson(github) }}'
          $Issuenumber = "${{ github.event.inputs.issue-number }}"

          $result = $(./gha-scripts/Check-IssueDetails.ps1 `
            -IssueNumber "${{ github.event.inputs.issue-number }}" `
            -DueDate "${{ vars.CSC_DUE_DATE }}" `
            -GitHubPayload $($payload | ConvertFrom-Json)) | ConvertFrom-Json

          echo "issueNumber=$($result.issueNumber)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "issueType=$($result.issueType)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "createdAt=$($result.createdAt)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "challengeCodeUserWrited=$($result.challengeCodeUserWrited)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "title=$($result.title)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "challengeCode=$($result.challengeCode)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "isValidChallengeCode=$($result.isValidChallengeCode)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "githubID=$($result.githubID)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "microsoftLearnProfile=$($result.microsoftLearnProfile)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "dateSubmitted=$($result.dateSubmitted)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "dateDue=$($result.dateDue)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
          echo "isOverdue=$($result.isOverdue)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

      - name: Add a label - Overdue
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ steps.issue.outputs.issueNumber }} \
            --add-label "overdue" \
            -R ${{ github.event.repository.full_name }}

      - name: Comment to issue - Overdue
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.issue.outputs.issueNumber }}
          body: |
            ğŸ‘‹ğŸ¼ @${{ steps.issue.outputs.githubId }} ë‹˜!

            * ì´ìŠˆ ì œì¶œ ì‹œê°: ${{ steps.issue.outputs.dateSubmitted }}
            * ì´ìŠˆ ë§ˆê° ì‹œê°: ${{ steps.issue.outputs.dateDue }}

            ì•ˆíƒ€ê¹ê²Œë„ ì œì¶œí•˜ì‹  ì´ìŠˆëŠ” ë§ˆê° ê¸°í•œì¸ ${{ steps.issue.outputs.dateDue }}ì„ ë„˜ê¸°ì…¨ìŠµë‹ˆë‹¤. ğŸ˜­ ë”°ë¼ì„œ, ì´ë²ˆ "ê¸°ì´ˆêµìœ¡ - í´ë¼ìš°ë“œ ìŠ¤í‚¬ ì±Œë¦°ì§€" ì™„ì£¼ì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

            ì´ë²ˆ 2024 í•´ì»¤ê·¸ë¼ìš´ë“œ í•´ì»¤í†¤ ë³¸ì„  í–‰ì‚¬ì—ëŠ” ì°¸ì—¬í•˜ì‹¤ ìˆ˜ ì—†ê²Œ ë˜ì—ˆì§€ë§Œ, ë‹¤ìŒ í•´ì»¤ê·¸ë¼ìš´ë“œ í•´ì»¤í†¤ì—ì„œëŠ” ê¼­ ì™„ì£¼í•˜ì…”ì„œ ë³¸ì„ ì—ì„œ ëµˆì–´ìš”! ğŸš€

            ê·¸ë™ì•ˆ í´ë¼ìš°ë“œ ìŠ¤í‚¬ ì±Œë¦°ì§€ ì´ë²¤íŠ¸ì— ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.

            ğŸ”¹ í•´ì»¤ê·¸ë¼ìš´ë“œ ìš´ì˜ì§„ ì¼ë™ ğŸ”¹

      - name: Close issue - Overdue
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close ${{ steps.issue.outputs.issueNumber }} \
            -c "ì±Œë¦°ì§€ ì œì¶œ ê¸°í•œì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ ë‹«ìŠµë‹ˆë‹¤." \
            -R ${{ github.event.repository.full_name }}

      - name: Add a label - Invalid challenge code
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'false' &&
          steps.issue.outputs.isValidChallengeCode == 'false'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ steps.issue.outputs.issueNumber }} \
            --add-label "invalid" \
            -R ${{ github.event.repository.full_name }}

      - name: Comment to issue - Invalid challenge code
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'false' &&
          steps.issue.outputs.isValidChallengeCode == 'false'
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.issue.outputs.issueNumber }}
          body: |
            ğŸ‘‹ğŸ¼ @${{ steps.issue.outputs.githubId }} ë‹˜!

            * ì œì¶œ ì±Œë¦°ì§€ ì½”ë“œ: `${{ steps.issue.outputs.challengeCodeUserWrited }}`
            * ì˜ˆìƒ ì±Œë¦°ì§€ ì½”ë“œ: `AZ-900`, `AI-900`

            ì•ˆíƒ€ê¹ê²Œë„ ì œì¶œí•˜ì‹  ì´ìŠˆëŠ” ì •í™•í•œ ì±Œë¦°ì§€ ì½”ë“œê°€ ì œëª©ì— í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì•„ í™•ì¸ì„ í•  ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ˜± ì±Œë¦°ì§€ ì½”ë“œëŠ” ìœ„ì— ì–¸ê¸‰í•œ ë‘ ê°€ì§€ ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤.

            ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ë‹«í ì˜ˆì •ì´ë‹ˆ, ìƒˆë¡­ê²Œ ì´ìŠˆë¥¼ ìƒì„±í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.

             ğŸ”¹ í•´ì»¤ê·¸ë¼ìš´ë“œ ìš´ì˜ì§„ ì¼ë™ ğŸ”¹

      - name: Close issue - Invalid challenge code
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'false' &&
          steps.issue.outputs.isValidChallengeCode == 'false'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close ${{ steps.issue.outputs.issueNumber }} \
            -c "ì±Œë¦°ì§€ ì½”ë“œë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ ë‹«ìŠµë‹ˆë‹¤." \
            -R ${{ github.event.repository.full_name }}

      - name: Add a label - Acknowledge
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'false' &&
          steps.issue.outputs.isValidChallengeCode == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ steps.issue.outputs.issueNumber }} \
            --add-label "csc,${{ steps.issue.outputs.challengeCode }},verifying" \
            -R ${{ github.event.repository.full_name }}

      - name: Comment to issue - Acknowledge
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'false' &&
          steps.issue.outputs.isValidChallengeCode == 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.issue.outputs.issueNumber }}
          emoji: "+1,rocket"
          body: |
            ğŸ‘‹ğŸ¼ @${{ steps.issue.outputs.githubId }} ë‹˜!

            ${{ steps.issue.outputs.ChallengeCode }} ì±Œë¦°ì§€ ì™„ë£Œ ì´ìŠˆë¥¼ ìƒì„±í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ‰

            ìƒì„±í•´ì£¼ì‹  ì´ìŠˆëŠ” í˜„ì¬ í™•ì¸ ì¤‘ì´ë©°, ì™„ë£Œ ì—¬ë¶€ë¥¼ í™•ì¸í•œ í›„ ë‹¤ì‹œ ì•Œë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

            ì°¸ê°€ìë‹˜ì˜ í•´ì»¤í†¤ ì™„ì£¼ë¥¼ ì‘ì›í•´ìš”! ğŸ’ªğŸ¼

            ğŸ”¹ í•´ì»¤ê·¸ë¼ìš´ë“œ ìš´ì˜ì§„ ì¼ë™ ğŸ”¹

      # - name: Call Power Automate workflow #ì¶”í›„ ì‚­ì œ ì˜ˆì •
      #   if: steps.issue-type.outputs.isCsc == 'true' && steps.checkpoint.outputs.isOverdue == 'false' && steps.challenge.outputs.isValidCode == 'true'
      #   id: request
      #   uses: fjogeleit/http-request-action@v1
      #   with:
      #     url: ${{ secrets.PAU_ON_CHALLENGE_SUBMITTED_URL }}
      #     method: 'POST'
      #     data: '{ "githubId": "${{ steps.issue.outputs.githubId }}", "msLearnProfileLink": "${{ steps.profile.outputs.link }}", "challengeCode": "${{ steps.challenge.outputs.codeUpper }}" }'

      - name: Check trophies
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'false' &&
          steps.issue.outputs.isValidChallengeCode == 'true'
        id: check-trophies
        shell: pwsh
        run: |
          $result='OK'
          echo "result=$result" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
      #        $result = dotnet run --project ./check-csc-trophy/Check-CscTrophy.csproj -- ${{ steps.issue.outputs.link }} ${{ steps.issue.outputs.challengeCode }}
      #        Write-Host "Result: $result"

      - name: Comment to issue - Do not complete the module
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'false' &&
          steps.issue.outputs.isValidChallengeCode == 'true' &&
          steps.check-trophies.outputs.result == 'Failed'
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.issue.outputs.issueNumber }}
          emoji: "+1,rocket"
          body: |
            ğŸ‘‹ğŸ¼ @${{ steps.issue.outputs.githubId }} ë‹˜!

            ì±Œë¦°ì§€ ì½”ë“œë¡œ ì…ë ¥í•´ì£¼ì‹  ${{ steps.issue.outputs.ChallengeCode }}ì˜ ëª¨ë“  ëª¨ë“ˆì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

            ${{ steps.issue.outputs.ChallengeCode }}ì˜ ëª¨ë“  ëª¨ë“ˆì„ ì™„ë£Œ í•˜ì‹  í›„ ì´ìŠˆë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”â—

            ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ë‹«í ì˜ˆì •ì´ë‹ˆ, ìƒˆë¡­ê²Œ ì´ìŠˆë¥¼ ìƒì„±í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.

             ğŸ”¹ í•´ì»¤ê·¸ë¼ìš´ë“œ ìš´ì˜ì§„ ì¼ë™ ğŸ”¹

      - name: Close issue - Do not complete the module
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'false' &&
          steps.issue.outputs.isValidChallengeCode == 'true' &&
          steps.check-trophies.outputs.result == 'Failed'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close ${{ steps.issue.outputs.issueNumber }} \
            -c "ëª¨ë“ˆ ì™„ì£¼ ê¸°ë¡ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ ë‹«ìŠµë‹ˆë‹¤." \
            -R ${{ github.event.repository.full_name }}

      - name: Add label
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'false' &&
          steps.issue.outputs.isValidChallengeCode == 'true' &&
          steps.check-trophies.outputs.result == 'OK'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ steps.issue.outputs.issueNumber }} \
          --add-label "verified" \
          -R ${{ github.event.repository.full_name }}

      - name: Comment to issue - Complete Learn modules.
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'false' &&
          steps.issue.outputs.isValidChallengeCode == 'true' &&
          steps.check-trophies.outputs.result == 'OK'
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.issue.outputs.issueNumber }}
          emoji: "+1,rocket"
          body: |
            ğŸ‘‹ğŸ¼ @${{ steps.issue.outputs.githubId }} ë‹˜!

            ${{ steps.issue.outputs.ChallengeCode }}ì˜ ëª¨ë“  ëª¨ë“ˆì„ ì™„ì£¼í•˜ì…¨ìŠµë‹ˆë‹¤!

            ì¶•í•˜ë“œë ¤ìš”. ğŸ‰ğŸ‰ğŸ‰

      - name: Remove label
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'false' &&
          steps.issue.outputs.isValidChallengeCode == 'true' &&
          steps.check-trophies.outputs.result == 'OK'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ steps.issue.outputs.issueNumber }} \
          --remove-label "verifying" \
          -R ${{ github.event.repository.full_name }}
      #    - name: Post message to Discord
      #      if: |
      #        steps.check-trophies.outputs.result == 'OK'
      #      uses: Ilshidur/action-discord@master
      #      env:
      #        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
      #      with:
      #        args: 'GitHub ID @${{ steps.issue.outputs.githubID }}ë‹˜ê»˜ì„œ ${{ steps.issue.outputs.ChallengeCode }} ê³¼ì •ì„ ë‹¬ì„±í•˜ì…¨ìŠµë‹ˆë‹¤.'

      - name: Comment and close Issue
        if: |
          steps.issue.outputs.issueType == 'CSC' &&
          steps.issue.outputs.isOverdue == 'false' &&
          steps.issue.outputs.isValidChallengeCode == 'true' &&
          steps.check-trophies.outputs.result == 'OK'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close ${{ steps.issue.outputs.issueNumber }} \
            -c "ì¶•í•˜ë“œë¦½ë‹ˆë‹¤, @${{ steps.issue.outputs.githubID }}ë‹˜!

            ${{ steps.issue.outputs.ChallengeCode }} ê³¼ì •ì„ ëë‚´ì„œ ìˆ˜ê³ í–ˆë‹¤ëŠ” ë§ì”€ ë“œë¦¬ê³  ì‹¶ì–´ìš”!

            ${{ steps.issue.outputs.ChallengeCode }} ê³¼ì •ì„ ë§ˆì¹˜ê³  ëŠë‚€ ê°ì •ì´ë‚˜ ì–´ë ¤ì› ë˜ ì ì„ ê³µìœ í•´ì£¼ì‹œë©´ ë”ìš± ì¢‹ê² ì–´ìš”.

            ì•ìœ¼ë¡œë„ í™”ì´íŒ…í•˜ì„¸ìš”!ğŸ‰ğŸ‰ğŸ‰ğŸ’ªğŸ’ªğŸ’ª

             ğŸ”¹ í•´ì»¤ê·¸ë¼ìš´ë“œ ìš´ì˜ì§„ ì¼ë™ ğŸ”¹ " \
            -R ${{ github.event.repository.full_name }}

#    - name: Call Power Automate workflow #í˜¸ì¶œ ì‹œ ì´ìŠˆ í´ë¡œì§• ì´ìœ  ë„˜ê¸°ê¸°(due date, invalid code, do not complete learn modules , success)
#      if: |
#        github.event.comment.user.login == github.event.issue.assignee.login &&
#        steps.challenge.outputs.isValidCode == 'true' &&
#        contains(github.event.comment.body, '/approve')
#      uses: fjogeleit/http-request-action@v1
#      with:
#        url: ${{ secrets.PAU_ON_CHALLENGE_VERIFIED_URL }}
#        method: 'POST'
#        data: '{ "githubId": "${{ github.event.issue.user.login }}", "challengeCode": "${{ steps.challenge.outputs.codeUpper }}" }'
