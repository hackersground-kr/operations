name: On Workshop Completion Verified

on:
  issue_comment:
    types:
      - created

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write

jobs:
  completion:
    name: "Completing Workshop verification"

    runs-on: ubuntu-latest

    steps:
      - name: Check event payload
        shell: pwsh
        run: |
          $eventPayload = '${{ toJson(github) }}'

      - name: Get workchop challenge code
        id: workshop-challenge
        shell: pwsh
        run: |
          $tz = [TimeZoneInfo]::FindSystemTimeZoneById("Asia/Seoul")
          $today = [DateTimeOffset]::New([TimeZoneInfo]::ConvertTimeBySystemTimeZoneId((Get-Date).ToUniversalTime(), "Asia/Seoul"))
          $workshop1 = [DateTimeOffset]::Parse("${{ vars.WORKSHOP_1_DUE_DATE }}").ToOffset($tz.GetUtcOffset($today))
          $workshop2 = [DateTimeOffset]::Parse("${{ vars.WORKSHOP_2_DUE_DATE }}").ToOffset($tz.GetUtcOffset($today))
          $workshop3 = [DateTimeOffset]::Parse("${{ vars.WORKSHOP_3_DUE_DATE }}").ToOffset($tz.GetUtcOffset($today))
          $workshop4 = [DateTimeOffset]::Parse("${{ vars.WORKSHOP_4_DUE_DATE }}").ToOffset($tz.GetUtcOffset($today))

          $challengeCode = if ($today -lt $workshop1) {
            "WORKSHOP-1"
          } elseif ($today -lt $workshop2) {
            "WORKSHOP-2"
          } elseif ($today -lt $workshop3) {
            "WORKSHOP-3"
          } elseif ($today -lt $workshop4) {
            "WORKSHOP-4"
          } else {
            "UNKNOWN"
          }
          
          echo "challengeCode=$challengeCode" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

      - name: Add label - COMPLETED
        if: |
          github.event.comment.user.login == github.event.issue.assignee.login &&
          steps.workshop-challenge.outputs.challengeCode != 'UNKNOWN' &&
          contains(github.event.comment.body, '/ok')
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
          --add-label "verified" \
          -R ${{ github.event.repository.full_name }}

      - name: Comment to issue - COMPLETED
        if: |
          github.event.comment.user.login == github.event.issue.assignee.login &&
          steps.workshop-challenge.outputs.challengeCode != 'UNKNOWN' &&
          contains(github.event.comment.body, '/ok')
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          emoji: "+1,rocket"
          body: |
            ğŸ‘‹ğŸ¼ @${{ github.event.issue.user.login }}ë‹˜!

            ì‚¬ì „ ì›Œí¬ìƒµ ê³¼ì œë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤!

            ì¶•í•˜ë“œë ¤ìš”. ğŸ‰ğŸ‰ğŸ‰

      - name: Remove label - COMPLETED
        if: |
          github.event.comment.user.login == github.event.issue.assignee.login &&
          steps.workshop-challenge.outputs.challengeCode != 'UNKNOWN' &&
          contains(github.event.comment.body, '/ok')
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
          --remove-label "verifying" \
          -R ${{ github.event.repository.full_name }}

      - name: Comment and close issue - COMPLETED
        if: |
          github.event.comment.user.login == github.event.issue.assignee.login &&
          steps.workshop-challenge.outputs.challengeCode != 'UNKNOWN' &&
          contains(github.event.comment.body, '/ok')
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close ${{ github.event.issue.number }} \
            -c "ì¶•í•˜ë“œë¦½ë‹ˆë‹¤, @${{ github.event.issue.user.login }}ë‹˜!

            ì‚¬ì „ ì›Œí¬ìƒµ ê³¼ì œë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤!!

            ì‚¬ì „ ì›Œí¬ìƒµ ê³¼ì •ì„ ë§ˆì¹˜ê³  ëŠê¼ˆë˜ ê°ì •ì´ë‚˜ ì–´ë ¤ì› ë˜ ì ì„ ë””ìŠ¤ì½”ë“œ ì±„ë„ì— ê³µìœ í•´ì£¼ì‹œë©´ ë”ìš± ì¢‹ê² ì–´ìš”.

            ì•ìœ¼ë¡œë„ í™”ì´íŒ…í•˜ì„¸ìš”!ğŸ‰ğŸ‰ğŸ‰ğŸ’ªğŸ’ªğŸ’ª

             ğŸ”¹ í•´ì»¤ê·¸ë¼ìš´ë“œ ìš´ì˜ì§„ ì¼ë™ ğŸ”¹ " \
            -R ${{ github.event.repository.full_name }}

      - name: Post message to Discord
        if: |
          github.event.comment.user.login == github.event.issue.assignee.login &&
          steps.workshop-challenge.outputs.challengeCode != 'UNKNOWN' &&
          contains(github.event.comment.body, '/ok')
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: "GitHub ID @${{ github.event.issue.user.login }}ë‹˜ê»˜ì„œ ì‚¬ì „ ì›Œí¬ìƒµ ê³¼ì œë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤."

      - name: Call Power Automate workflow
        if: |
          github.event.comment.user.login == github.event.issue.assignee.login &&
          steps.workshop-challenge.outputs.challengeCode != 'UNKNOWN' &&
          contains(github.event.comment.body, '/ok')
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.PAU_ON_WORKSHOP_COMPLETED_URL }}
          method: "POST"
          data: '{ "githubId": "${{ github.event.issue.user.login }}", "challengeCode": "${{ steps.workshop-challenge.outputs.challengeCode }}", "challengeStatus": "COMPLETED" }'
